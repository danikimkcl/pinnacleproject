---
title: "Association between Parkinsonism/PD and frailty"
output: html_document
date: "2023-07-27"
---

### Open libraries

```{r}
library(cowplot)
library(broom)      # for tidy()
library(data.table) # for rbindlist()
library(descr)      # for crosstab(), descriptive statistics package
library(ggVennDiagram)
library(gridGraphics) # for grid.grab()
library(gtsummary)  # for tbl_regression()
library(here)       # for easy file referencing by using the top-level directory of a file project
library(kableExtra)
library(knitr)
library(meta)       # meta-analysis
library(survival)
library(tableone)
library(tidyverse)
```

What is the top-level of current project?
```{r}
here::here()
```

### Open dataset

#### Open and process Baseline phase

Source codes
```{r}
source(here::here("Script", "Functions", "Data process", "func_open_and_process_data.R"))
source(here::here("Script", "Functions", "Data process", "func_compute_pd_variables.R"))
```

Set path for function input 
```{r}
path = here::here("Data", "raw data", "baseline survey", "prevalence_survey_data_1_3.dta")
```

Open dataset
```{r}
data = open_and_process_data(path, "dta") # this function opens a Stata dataset (dta) and converts Stata's labelled variables into factors
```

Process Parkinsonism and PD variables
```{r}
data = compute_pd_variables(data)
```

Subset relevant variables
```{r}
varnames = data %>% 
  select(houseid2, PARTICID, countryid, centreid, age, gender, rural, Nassets, PMARRY, CARENEED, illnocat, cdem1066, PEDUC, PTOLDDM, PSMOKE, PALCNOW, PALCPAST, PACTIVE, PMEATFRQ, PFISHFRQ, PVEGS, NEO14G, NEO6AU, NEO6AL, NEO6BU, NEO6BL, NEO4E, NEO4F, NOE1, NEO14E, PCVA, medserv, PPC, PHOSP, POTH, PPD, PDENT, PTH, PHOSAD, pnism, JorgePD, parkinsonism, PARK) %>% 
  names()

data = data %>% select_if(names(.) %in% varnames)
```

Recode `parkinsonism` variable

```{r}
data = data %>% 
  mutate(parkinsonism = if_else(parkinsonism == "Parkinsonian", 1, 0, NA_real_))

summary(as.factor(data$parkinsonism))
```

Create a PD variable that combines the algorithm-based dx (`JorgePD`) and self-reported dx (`PARK`)

```{r}
# Create a PD variable that combines the algorithm-based dx (`JorgePD`) and self-reported dx (`PARK`)
data = data %>% 
  mutate(PD = case_when(JorgePD==1 | PARK=="probable" | PARK=="certain" ~ 1, 
                        JorgePD==0 | PARK=="no" ~ 0, 
                        TRUE ~ NA_real_))

summary(as.factor(data$PD))
```

Cross-tabulation of Jorge PD and self-reported PD

```{r}
temp = data %>% 
  select(JorgePD, PARK) %>% 
  mutate(PARK = if_else(PARK=="probable" | PARK=="certain", 1, 0))
table(temp$PARK, temp$JorgePD, useNA="always")
```

#### Open proprocessed frailty variables

Open rds file

```{r}
data_base_frail = readRDS(here::here("Data", "processed data", "data_baseline_frailty.rds")) 
data_inc_frail = readRDS(here::here("Data", "processed data", "data_incidence_frailty.rds")) 
```

Drop observations from China or India
```{r}
data_base_frail = data_base_frail %>% filter(centreid %in% c("Cuba", "DR", "Peru (urban)", "Peru (rural)", "Venezuela", "Mexico (urban)", "Mexico (rural)", "Puerto Rico"))
data_inc_frail = data_inc_frail %>% filter(centreid %in% c("Cuba", "DR", "Peru (urban)", "Peru (rural)", "Venezuela", "Mexico (urban)", "Mexico (rural)", "Puerto Rico"))

# drop unused factor levels
data_base_frail$centreid = droplevels(data_base_frail$centreid)
data_inc_frail$centreid = droplevels(data_inc_frail$centreid)
```

#### Subset data for Latin America

```{r}
# Create function to drop observations from certain countries and relabel countries

process_country_var = function(data){
  
  data = data %>% 
    filter(centreid %in% c("Cuba", "DR", "Peru (urban)", "Peru (rural)", "Venezuela", "Mexico (urban)", "Mexico (rural)", "Puerto Rico"))
  
  # drop unused factor levels
  data$centreid = droplevels(data$centreid)
  data$countryid = droplevels(data$countryid)
  
  data$countryid = factor(data$countryid, levels = c("Cuba", "DR", "Peru", "Venezuela", "Mexico", "Puerto Rico"),
                        labels = c("Cuba", "Dominican Republic", "Peru", "Venezuela", "Mexico", "Puerto Rico"))
  
  return(data)
  
}

data = process_country_var(data)
data_base_frail = process_country_var(data_base_frail)
data_inc_frail = process_country_var(data_inc_frail)
```

#### Data for cross-sectional analysis: Subset participants with complete cases on frailty and PD variables

```{r}
# Baseline data
data_base_complete = data %>% 
  select(houseid2, PARTICID, pnism, PD) %>% 
  left_join(select(data_base_frail, houseid2, PARTICID, starts_with("b_fp."), starts_with("b_mf."), starts_with("b_fi.")), by = c("houseid2", "PARTICID")) %>% 
  filter(complete.cases(.)) %>% 
  mutate(id=row_number())

# Merge back covariates
data_base_complete = data %>%  
  select(houseid2, PARTICID, countryid, age, gender, PMARRY, PEDUC, Nassets, illnocat, CARENEED) %>% 
  right_join(data_base_complete, by = c("houseid2", "PARTICID"))

#data_fp = data %>% filter(!is.na(fp_frail))
#data_mf = data %>% filter(!is.na(mf_frail))
```

#### Data for prospective analysis

```{r}
# Open follow-up status data
# Create data path for follow-up status at incidence phase
path = here::here("Data", "raw data", "fu folder from Matthew", "incidence cohort (all survey outcomes)", "other countries", "status_outcome (survey cohort)_1_0.sav")
status_outcome = open_and_process_data(path, "sav")

# Relabel country and id variables to match the other dataframe
status_outcome = status_outcome %>% 
  mutate(centreid_num = case_when(centreid == "Cuba" ~ 10,
                                  centreid == "DR" ~ 20,
                                  centreid == "Peru (urban)" ~ 30,
                                  centreid == "Peru (rural)" ~ 40,
                                  centreid == "Venezuela" ~ 50,
                                  centreid == "Mexico (urban)" ~ 60,
                                  centreid == "Mexico (rural)" ~ 70,
                                  centreid == "China (urban)" ~ 100,
                                  centreid == "China (rural)" ~ 110,
                                  centreid == "Puerto Rico" ~ 200)) %>% 
  mutate(HOUSEID = stringr::str_pad(HOUSEID, 4, pad="0")) %>% 
  mutate(houseid2 = as.numeric(paste0(centreid_num, HOUSEID))) %>% 
  select(-HOUSEID, -centreid_num, -centreid)

# Merge in follow-up status & gender to incidence phase data
temp = data %>% 
  left_join(status_outcome, by = c("houseid2", "PARTICID"))
  
summary(temp$Statusfu)

# Select participants who either died or interviewed by follow-up (i.e. exclude refused, uncontactable, not traced, not recorded or NA)
# Merge in frailty data
temp = temp %>% 
  filter(Statusfu=="Died" | Statusfu=="Interviewed") %>% 
  left_join(select(data_inc_frail, houseid2, PARTICID, starts_with("i_fi."), starts_with("i_fp."), starts_with("i_mf.")), by=c("houseid2", "PARTICID")) %>% 
  left_join(select(data_base_frail, houseid2, PARTICID, starts_with("b_fi."), starts_with("b_fp."), starts_with("b_mf.")), by=c("houseid2", "PARTICID"))

# Create separate datasets by frailty definition
temp_fp = temp %>% select(-contains("fi"), -contains("mf"))
temp_mf = temp %>% select(-contains("fp"), -contains("fi"))
temp_fi = temp %>% select(-contains("fp"), -contains("mf"))

# Subset participants with complete data
subset_df = function(df, vars){
  
  print(nrow(df))
  
  # Filter participants with complete data on pd, pnism and frailty at baseline
  temp1 = df %>% filter(if_all(vars, complete.cases))
  
  print(nrow(temp1))
  
  return(temp1)
}

temp_fp = subset_df(df=temp_fp, vars=c("pnism", "PD", "b_fp.frail"))
temp_mf = subset_df(df=temp_mf, vars=c("pnism", "PD", "b_mf.frail"))
temp_fi = subset_df(df=temp_fi, vars=c("pnism", "PD", "b_fi.frail"))

# Filter participants without frailty at baseline
data_fp = subset(temp_fp, b_fp.frail==0)
data_mf = subset(temp_mf, b_mf.frail==0)
data_fi = subset(temp_fi, b_fi.frail==0)

# Subset participants who either died or have frailty data at follow-up
data_fp = subset(data_fp, Statusfu=="Died" | !is.na(i_fp.frail))
data_mf = subset(data_mf, Statusfu=="Died" | !is.na(i_mf.frail))
data_fi = subset(data_fi, Statusfu=="Died" | !is.na(i_fi.frail))
```

Venn diagram of frail participants at baseline

```{r}
x = list(`FI` = data_base_complete %>% filter(b_fi.frail==1) %>% pull(id), 
         `FP` = data_base_complete %>% filter(b_fp.frail==1) %>% pull(id), 
         `MF` = data_base_complete %>% filter(b_mf.frail==1) %>% pull(id))

ggVennDiagram::ggVennDiagram(x, 
                             set_color = c("black", "black", "black"),
                             color = c("black", "black", "black"), 
                             edge_size = 1, 
                             edge_lty = "solid") +
  scale_fill_gradient(low = "#F4FAFE", high = "#4981BF") +
  theme(legend.position = "none")
```

# Descriptive analysis

### Table 1 Baseline characteristics of the 10/66 participants from Latin American countries

```{r, include=FALSE}
vars = c("age", "gender", "PMARRY", "PEDUC", "Nassets", "illnocat", "CARENEED", "pnism", "PD", "b_fp.frail", "b_mf.frail", "b_fi.frail")
factorVars = c("gender", "PMARRY", "PEDUC", "Nassets",  "illnocat", "CARENEED", "pnism", "PD", "b_fp.frail", "b_mf.frail", "b_fi.frail")

# include missing as a separate factor level
tab1 = tableone::CreateTableOne(data = data_base_complete,
                                vars = vars,
                                factorVars = factorVars,
                                strata = c("countryid"),
                               #includeNA = TRUE,
                                addOverall = TRUE)

table1 = print(tab1)
```

```{r, echo=FALSE}
print(tab1) %>% 
  kbl() %>% 
  kable_paper("hover", full_width=FALSE)
```

Save table

```{r}
path = here::here("Output", "PD and frailty paper", "Table1.csv")
write.csv(table1, path)
```

### Baseline characteristics by whether participants were followed-up and interviewed at incidence phase versus lost to follow-up

```{r}
temp = data %>% 
  left_join(status_outcome, by = c("houseid2", "PARTICID")) %>% 
  mutate(fu = factor(if_else(Statusfu=="Died" | Statusfu=="Interviewed", 1, 0, missing=0)))

vars = c("age", "gender", "PMARRY", "PEDUC", "Nassets", "illnocat", "CARENEED", "pnism", "PD")
factorVars = c("gender", "PMARRY", "PEDUC", "Nassets",  "illnocat", "CARENEED", "pnism", "PD")

# include missing as a separate factor level
tab_fu = tableone::CreateTableOne(data = temp,
                                vars = vars,
                                factorVars = factorVars,
                                strata = c("fu"),
                               #includeNA = TRUE,
                                addOverall = TRUE)

table_fu = print(tab_fu)

write.csv(table_fu, here::here("Output", "PD and frailty paper", "Table1_follow-up.csv"))
```

### Baseline characteristics by frailty status at follow-up

```{r, include=FALSE}
vars = c("age", "gender", "PMARRY", "PEDUC", "Nassets", "illnocat", "CARENEED", "pnism", "PD")
factorVars = c("gender", "PMARRY", "PEDUC", "Nassets",  "illnocat", "CARENEED", "pnism", "PD")

# include missing as a separate factor level
tab_fp = tableone::CreateTableOne(data = data_fp,
                                vars = vars,
                                factorVars = factorVars,
                                strata = c("i_fp.frail"),
                               #includeNA = TRUE,
                                addOverall = TRUE)

table_fp = print(tab_fp)

tab_mf = tableone::CreateTableOne(data = data_mf,
                                vars = vars,
                                factorVars = factorVars,
                                strata = c("i_mf.frail"),
                               #includeNA = TRUE,
                                addOverall = TRUE)

table_mf = print(tab_mf)

tab_fi = tableone::CreateTableOne(data = data_fi,
                                vars = vars,
                                factorVars = factorVars,
                                strata = c("i_fi.frail"),
                               #includeNA = TRUE,
                                addOverall = TRUE)

table_fi = print(tab_fi)
```

Save table

```{r}
write.csv(table_fp, here::here("Output", "PD and frailty paper", "Table1_fp.csv"))
write.csv(table_mf, here::here("Output", "PD and frailty paper", "Table1_mf.csv"))
write.csv(table_fi, here::here("Output", "PD and frailty paper", "Table1_fi.csv"))
```

# Cross-sectional association between Parkinsonism/PD and frailty at baseline

## Cross-tabulation and chi-square test

### PD/Parkinsonism and Fried frailty phenotype (FP)

```{r}
descr::crosstab(data_base_complete$PD, data_base_complete$b_fp.frail, prop.r=TRUE, chisq=TRUE)

descr::crosstab(data_base_complete$pnism, data_base_complete$b_fp.frail, prop.r=TRUE, chisq=TRUE)
```

### PD/Parkinsonism and Multidimensional frailty (MF)

```{r}
descr::crosstab(data_base_complete$PD, data_base_complete$b_mf.frail, prop.r=TRUE, chisq=TRUE)

descr::crosstab(data_base_complete$pnism, data_base_complete$b_mf.frail, prop.r=TRUE, chisq=TRUE)
```

### PD/Parkinsonism and Fried frailty index (FI)

```{r}
descr::crosstab(data_base_complete$PD, data_base_complete$b_fi.frail, prop.r=TRUE, chisq=TRUE)

descr::crosstab(data_base_complete$pnism, data_base_complete$b_fi.frail, prop.r=TRUE, chisq=TRUE)
```

### Percentage frailty by PD and dependency status

```{r}
to_plot1 = data_complete %>% 
  group_by(CARENEED, PD, fp_frail) %>% 
  summarise(n = n()) %>% 
  mutate(pct = n/sum(n)*100) %>% 
  filter(!fp_frail==0) %>% 
  mutate(frailty = "Frailty Phenotype") %>% 
  select(frailty, CARENEED, PD, pct)

to_plot2 = data_complete %>% 
  group_by(CARENEED, PD, mf_frail) %>% 
  summarise(n = n()) %>% 
  mutate(pct = n/sum(n)*100) %>% 
  filter(!mf_frail==0) %>% 
  mutate(frailty = "Multidimensional Frailty") %>% 
  select(frailty, CARENEED, PD, pct)

to_plot_pd = bind_rows(to_plot1, to_plot2) %>% 
  mutate(PD = as.factor(PD), levels=c("0", "1"), labels=c("No", "Yes"))

to_plot1 = data_complete %>% 
  group_by(CARENEED, pnism, fp_frail) %>% 
  summarise(n = n()) %>% 
  mutate(pct = n/sum(n)*100) %>% 
  filter(!fp_frail==0) %>% 
  mutate(frailty = "Frailty Phenotype") %>% 
  select(frailty, CARENEED, pnism, pct)

to_plot2 = data_complete %>% 
  group_by(CARENEED, pnism, mf_frail) %>% 
  summarise(n = n()) %>% 
  mutate(pct = n/sum(n)*100) %>% 
  filter(!mf_frail==0) %>% 
  mutate(frailty = "Multidimensional Frailty") %>% 
  select(frailty, CARENEED, pnism, pct)

to_plot_pnism = bind_rows(to_plot1, to_plot2) %>% 
  mutate(Parkinsonism = as.factor(pnism), levels=c("0", "1"), labels=c("No", "Yes"))
```

Bar plot of frailty prevalence by dependency and PD/parkinsonism 

```{r}
p1 = ggplot(data=to_plot_pd, aes(x=forcats::fct_rev(CARENEED), y=pct, fill=PD)) +
  geom_bar(stat="identity", position=position_dodge(0.8), width=0.7) +
  #geom_text(aes(label=round(pct,0)), vjust=0, hjust=0.5) +
  scale_y_continuous(limits=c(0,100), breaks = seq(0, 100, by=20)) +
  scale_x_discrete(labels=c("None", "Some of\nthe time", "Much of\nthe time")) +
  scale_fill_manual(values=c("lightgray", "black"), labels=c("No", "Yes")) +
  ggtitle("Frailty prevalence by dependency and Parkinson's disease") +
  labs(x="Level of dependency (care need)",
       y="Frailty (%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5),
        legend.position = "bottom") +
  facet_wrap(~frailty)

p1
```

```{r}
p2 = ggplot(data=to_plot_pnism, aes(x=forcats::fct_rev(CARENEED), y=pct, fill=Parkinsonism)) +
  geom_bar(stat="identity", position=position_dodge(0.8), width=0.7) +
  #geom_text(aes(label=round(pct,0)), vjust=0, hjust=0.5) +
  scale_y_continuous(limits=c(0,100), breaks = seq(0, 100, by=20)) +
  scale_x_discrete(labels=c("None", "Some of\nthe time", "Much of\nthe time")) +
  scale_fill_manual(values=c("lightgray", "black"), labels=c("No", "Yes")) +
  ggtitle("Frailty prevalence by dependency and parkinsonism") +
  labs(x="Level of dependency (care need)",
       y="Frailty (%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5),
        legend.position = "bottom") +
  facet_wrap(~frailty)

p2
```
Save plots

```{r}
ggsave(filename="frailty_by_dependency_pd.png", plot=p1, width=15, height=10, units="cm", path="C:/Users/k2258693/OneDrive - King's College London/Desktop/R Projects/pinnacleproject/Output/PD and frailty paper/plots")
ggsave(filename="frailty_by_dependency_pnism.png", plot=p2, width=15, height=10, units="cm", path="C:/Users/k2258693/OneDrive - King's College London/Desktop/R Projects/pinnacleproject/Output/PD and frailty paper/plots")
```

## Logistic regression: overall estimates

```{r}
func_logreg_overall = function(data, outcome, exposure, adj){
  
  # Formula for the logistic regression
  formula = as.formula(paste0(outcome, " ~ ", exposure, adj))
    
  model = glm(formula, family = binomial(link="logit"), data=data) # logistic regression
  
  output = tidy(model, conf.int = TRUE, conf.level = 0.95, exponentiate = TRUE) %>% # process regression output
    mutate(ors = paste0(format.pval(round(estimate,2),nsmall=2), " (", format.pval(round(conf.low,2),nsmall=2),"-", format.pval(round(conf.high,2),nsmall=2),")")) %>% 
    select(exposure=term, ors)
    
  output$outcome = outcome # label outcome
  output$n = NA  # number of events
    
  output = output[output$exposure==exposure, ] # select ORs for exposure of interest
  
  return(output)
  
}
```

```{r}
frailty = list("b_fp.frail", "b_mf.frail", "b_fi.frail")

ors_pnism_frail_adj = lapply(frailty, func_logreg_overall, data=data_base_complete, exposure="pnism", adj=" + age + gender + PEDUC + illnocat")
ors_pd_frail_adj = lapply(frailty, func_logreg_overall, data=data_base_complete, exposure="PD", adj=" + age + gender + PEDUC + illnocat")

data.table::rbindlist(ors_pnism_frail_adj)
data.table::rbindlist(ors_pd_frail_adj)
```

## Logistic regression: site-specific estimates

Create function to run logistic regression models

```{r}
func_logreg = function(data, outcome, exposure, adj, country){
  
  # Create an empty output df
  output = data.frame(
    outcome = NA,
    exposure = NA,
    study.site = NA,
    ors = NA,
    estimate = NA,
    std.error = NA
  )
  
  # List countries to iterate logistic regression through
  #countries = c("Cuba", "DR", "Peru (urban)", "Peru (rural)", "Venezuela", "Mexico (urban)", "Mexico (rural)", "Puerto Rico")
  countries = c("Cuba", "Dominican Republic", "Peru", "Venezuela", "Mexico", "Puerto Rico")
  
  # Formula for the logistic regression
  formula = as.formula(paste0(outcome, " ~ ", exposure, adj))
  
  for (i in countries){
    # logistic regression
    model = glm(formula, family = binomial(link="logit"), data=data, subset=countryid==i) # make sure subset column is correct - either centreid or countryid
  
    temp = tidy(model, conf.int = TRUE, conf.level = 0.95, exponentiate = TRUE) %>% # process regression output
      mutate(ors = paste0(format.pval(round(estimate,2),nsmall=2), " (", format.pval(round(conf.low,2),nsmall=2),"-", format.pval(round(conf.high,2),nsmall=2),")")) %>% 
      mutate(estimate = log(estimate)) %>% 
      select(exposure=term, ors, estimate, std.error)
    
    temp$outcome = outcome # label outcome
    temp$study.site = i #label study site
    
    temp = temp[temp$exposure==exposure, ] # select ORs for exposure of interest
    
    output = bind_rows(output, temp)
  
  }
  
  return(output)
  
}
```

Run models

```{r, message=FALSE, warning=FALSE}
adjustments = " + age + gender + PEDUC + illnocat"
adjustments1 = " + age + gender + PEDUC + illnocat + CARENEED"

################# Parkinsonism #####################

# FP
ors_pnism_fp_crude = func_logreg(data=data_base_complete, outcome="b_fp.frail", exposure="pnism", adj="")
ors_pnism_fp_adj = func_logreg(data=data_base_complete, outcome="b_fp.frail", exposure="pnism", adj= adjustments)
ors_pnism_fp_adj1 = func_logreg(data=data_base_complete, outcome="b_fp.frail", exposure="pnism", adj= adjustments1)

# Multidimensional frailty
ors_pnism_mf_crude = func_logreg(data=data_base_complete, outcome="b_mf.frail", exposure="pnism", adj="")
ors_pnism_mf_adj = func_logreg(data=data_base_complete, outcome="b_mf.frail", exposure="pnism", adj= adjustments)
ors_pnism_mf_adj1 = func_logreg(data=data_base_complete, outcome="b_mf.frail", exposure="pnism", adj= adjustments1)

# FI
ors_pnism_fi_crude = func_logreg(data=data_base_complete, outcome="b_fi.frail", exposure="pnism", adj="")
ors_pnism_fi_adj = func_logreg(data=data_base_complete, outcome="b_fi.frail", exposure="pnism", adj= adjustments)
ors_pnism_fi_adj1 = func_logreg(data=data_base_complete, outcome="b_fi.frail", exposure="pnism", adj= adjustments1)

################# PD #####################

# FP
ors_pd_fp_crude = func_logreg(data=data_base_complete, outcome="b_fp.frail", exposure="PD", adj="")
ors_pd_fp_adj = func_logreg(data=data_base_complete, outcome="b_fp.frail", exposure="PD", adj=adjustments)
ors_pd_fp_adj1 = func_logreg(data=data_base_complete, outcome="b_fp.frail", exposure="PD", adj=adjustments1)

# Multidimensional frailty
ors_pd_mf_crude = func_logreg(data=data_base_complete, outcome="b_mf.frail", exposure="PD", adj="")
ors_pd_mf_adj = func_logreg(data=data_base_complete, outcome="b_mf.frail", exposure="PD", adj=adjustments)
ors_pd_mf_adj1 = func_logreg(data=data_base_complete, outcome="b_mf.frail", exposure="PD", adj=adjustments1)

# FI
ors_pd_fi_crude = func_logreg(data=data_base_complete, outcome="b_fi.frail", exposure="PD", adj="")
ors_pd_fi_adj = func_logreg(data=data_base_complete, outcome="b_fi.frail", exposure="PD", adj=adjustments)
ors_pd_fi_adj1 = func_logreg(data=data_base_complete, outcome="b_fi.frail", exposure="PD", adj=adjustments1)
```

## Logistic regression: meta-analysis

Run random-effects model, assumes there are 2 sources of error: 1) sampling error and 2) variance from the fact that included study sites are not from a single, homogeneous population, thus there is distribution of true effect sizes. Thus, the random-effects model aims to model the mean of the distribution of true effects.

Create function to plot forest plot

```{r}
plot_forest_meta = function(results){
  
  mgen = meta::metagen(TE = estimate,                           # make sure log(OR) than OR only
                       seTE = std.error,
                       studlab = study.site,
                       sm = "OR",
                       fixed = TRUE,
                       random = FALSE,
                       method.tau = "DL",                       # DerSimonian-Laird estimator
                       hakn = TRUE,                             # Hartung-Knapp adjustment of SEs
                       prediction = FALSE,                       # the above line and this line allow more   uncertainty in the estimation of between-study heterogeneity and appropriate for use in random-effects   meta-analysis
                       data = results)
  
  meta::forest(mgen, 
             rightlabs = c("OR", "95% CI", "Weight"),
             print.tau2 = FALSE,
             leftcols = c("studlab"))
  
  plot = grid.grab() 
  
  return(plot)

}
```

### Parkinsonism and frailty (adjusted for age, sex, education, illnocat, and careneed)

```{r, fig.width = 10, fig.height = 6}
plot_pnism_fp_adj = plot_forest_meta(ors_pnism_fp_adj[-1, ])
plot_pnism_fp_adj1 = plot_forest_meta(ors_pnism_fp_adj1[-1, ])

plot_pnism_mf_adj = plot_forest_meta(ors_pnism_mf_adj[-1, ])
plot_pnism_mf_adj1 = plot_forest_meta(ors_pnism_mf_adj1[-1, ])

plot_pnism_fi_adj = plot_forest_meta(ors_pnism_fi_adj[-1, ])
plot_pnism_fi_adj1 = plot_forest_meta(ors_pnism_fi_adj1[-1, ])
```

### PD and frailty (adjusted for age, sex, education, illnocat, and careneed)

```{r, fig.width = 10, fig.height = 6}
plot_pd_fp_adj = plot_forest_meta(ors_pd_fp_adj[-c(1), ])
plot_pd_fp_adj1 = plot_forest_meta(ors_pd_fp_adj1[-c(1), ])

plot_pd_mf_adj = plot_forest_meta(ors_pd_mf_adj[-c(1), ])
plot_pd_mf_adj1 = plot_forest_meta(ors_pd_mf_adj1[-c(1), ])

plot_pd_fi_adj = plot_forest_meta(ors_pd_fi_adj[-c(1), ])
plot_pd_fi_adj1 = plot_forest_meta(ors_pd_fi_adj1[-c(1), ])
```

## Combine and save outputs

### Main results

```{r}
plot_combined_pnism_adj = cowplot::plot_grid(plot_pnism_fp_adj1, plot_pnism_mf_adj1, plot_pnism_fi_adj1,
                                         align = "hv",
                                         labels = "AUTO", 
                                         scale = 0.5,
                                         ncol = 1)

ggsave(plot = plot_combined_pnism_adj, filename = here::here("Output", "PD and frailty paper", "plots", "ors_pnism_frailty_adj1.png"), width = 18, height = 24, units = "cm")

plot_combined_pd_adj = cowplot::plot_grid(plot_pd_fp_adj1, plot_pd_mf_adj1, plot_pd_fi_adj1,
                                         align = "hv",
                                         labels = "AUTO", 
                                         scale = 0.5,
                                         ncol = 1)

ggsave(plot = plot_combined_pd_adj, filename = here::here("Output", "PD and frailty paper", "plots", "ors_pd_frailty_adj1.png"), width = 18, height = 24, units = "cm")
```


# Prospective association between Parkinsonism/PD and frailty at baseline

**Cause-specific hazards**

Open mortality status
```{r}
path = here::here("Data", "raw data", "fu folder from Matthew", "specific outcomes", "mortality", "mortality_outcome1_1.dta")
mortality_outcome = open_and_process_data(path, "dta")
```

Merge vital status
```{r}
# baseline data:
# houseid2 is composite of centreid and houseid (houseid has 4 digits)
# therefore, unique participant-level id = composite of houseid2 and PARTICID

# status_outcome_mortality_cohort:
# need to create houseid2 by combining centreid and houseid (need to add leading 0s up to 4 digits first)
# centreid
# - 10 Cuba
# - 20 Dominican Republic
# - 30 Peru (urban)
# - 40 Peru (rural)
# - 50 Venezuela
# - 60 Mexico (urban)
# - 70 Mexico (rural)
# - 100 China (urban)
# - 110 China (rural)
# - 200 Puerto Rico

# Create houseid2
mortality_outcome = mortality_outcome %>% 
  mutate(centreid_num = case_when(centreid == "Cuba" ~ 10,
                                  centreid == "DR" ~ 20,
                                  centreid == "Peru (urban)" ~ 30,
                                  centreid == "Peru (rural)" ~ 40,
                                  centreid == "Venezuela" ~ 50,
                                  centreid == "Mexico (urban)" ~ 60,
                                  centreid == "Mexico (rural)" ~ 70,
                                  centreid == "China (urban)" ~ 100,
                                  centreid == "China (rural)" ~ 110,
                                  centreid == "Puerto Rico" ~ 200)) %>% 
  mutate(HOUSEID = stringr::str_pad(HOUSEID, 4, pad="0")) %>% 
  mutate(houseid2 = as.numeric(paste0(centreid_num, HOUSEID))) %>% 
  select(houseid2, PARTICID, dead2, censor_days, censor_yr, vital_ascertained)

# Merge vital status with data
data_fp1 = data_fp %>% left_join(mortality_outcome, by = c("houseid2", "PARTICID"))
data_mf1 = data_mf %>% left_join(mortality_outcome, by = c("houseid2", "PARTICID"))
data_fi1 = data_fi %>% left_join(mortality_outcome, by = c("houseid2", "PARTICID"))
```

Create outcome variable
```{r}
data_fp1 = data_fp1 %>% 
  mutate(status = if_else(i_fp.frail==1, 1, 0),
         time = case_when(i_fp.frail==1 ~ censor_days/2,
                          TRUE ~ censor_days))

data_mf1 = data_mf1 %>% 
  mutate(status = if_else(i_mf.frail==1, 1, 0),
         time = case_when(i_mf.frail==1 ~ censor_days/2,
                          TRUE ~ censor_days))

data_fi1 = data_fi1 %>% 
  mutate(status = if_else(i_fi.frail==1, 1, 0),
         time = case_when(i_fi.frail==1 ~ censor_days/2,
                          TRUE ~ censor_days))
```

Check PH assumption
```{r}
res.cox = survival::coxph(Surv(time, status) ~ PD, data = data_fp1)
test.ph = survival::cox.zph(res.cox)
test.ph

res.cox = survival::coxph(Surv(time, status) ~ PD + age + gender + PEDUC + illnocat, data = data_fp1)
test.ph = survival::cox.zph(res.cox)
test.ph
```

Check if stratification fixes this

```{r}
res.cox = survival::coxph(Surv(time, status) ~ PD + age + gender + strata(PEDUC) + strata(illnocat), data = data_fp1)
test.ph = survival::cox.zph(res.cox)
test.ph
```

## Cox Proportionak Hazards Regression model

Create function to run CoxPH regression models

```{r}
func_coxph = function(data, exposure, adj, country){
  
  # Create an empty output df
  output = data.frame(
    exposure = NA,
    study.site = NA,
    hrs = NA,
    estimate = NA,
    std.error = NA
  )
  
  # List countries to iterate Cox PH regression through
  #countries = c("Cuba", "DR", "Peru (urban)", "Peru (rural)", "Venezuela", "Mexico (urban)", "Mexico (rural)", "Puerto Rico") 
  countries = c("Cuba", "Dominican Republic", "Peru", "Venezuela", "Mexico", "Puerto Rico") # using study sites results in small numbers, use country-level variable
  
  # Formula for the Cox PH regression
  outcome = "Surv(time, status)"
  formula = as.formula(paste0(outcome, " ~ ", exposure, adj))
  
  for (i in countries){
    
    model = coxph(formula, data=data, subset=countries==i) # cox regression
  
    temp = tidy(model, conf.int = TRUE, conf.level = 0.95, exponentiate = TRUE) %>% # process regression output
      mutate(hrs = paste0(format.pval(round(estimate,2),nsmall=2), " (", format.pval(round(conf.low,2),nsmall=2),"-", format.pval(round(conf.high,2),nsmall=2),")")) %>% 
      mutate(estimate = log(estimate)) %>% 
      select(exposure=term, hrs, estimate, std.error)
    
    temp$study.site = i #label study site
    
    temp = temp[temp$exposure==exposure, ] # select ORs for exposure of interest
    
    output = bind_rows(output, temp)
  
  }
  
  return(output)
  
}
```

Run models

```{r, message=FALSE, warning=FALSE}
hrs_pnism_fp_adj = func_coxph(data=data_fp1, exposure="pnism", adj=" + age + gender + strata(PEDUC) + strata(illnocat)")
hrs_pnism_mf_adj = func_coxph(data=data_mf1, exposure="pnism", adj=" + age + gender + strata(PEDUC) + strata(illnocat)")
hrs_pnism_fi_adj = func_coxph(data=data_fi1, exposure="pnism", adj=" + age + gender + strata(PEDUC) + strata(illnocat)")

hrs_pd_fp_adj = func_coxph(data=data_fp1, exposure="PD", adj=" + age + gender + strata(PEDUC) + strata(illnocat)")
hrs_pd_mf_adj = func_coxph(data=data_mf1, exposure="PD", adj=" + age + gender + strata(PEDUC) + strata(illnocat)")
hrs_pd_fi_adj = func_coxph(data=data_fi1, exposure="PD", adj=" + age + gender + strata(PEDUC) + strata(illnocat)")
```

### Parkinsonism and incident frailty

```{r}
kable(hrs_pnism_fp_adj[-1,])
kable(hrs_pnism_mf_adj[-1,])
kable(hrs_pnism_fi_adj[-1,])
```

### PD and incident frailty

```{r}
kable(hrs_pd_fp_adj[-1,])
kable(hrs_pd_mf_adj[-1,])
kable(hrs_pd_fi_adj[-1,])
```

## Cox PH regression: meta-analysis

Run random-effects model, assumes there are 2 sources of error: 1) sampling error and 2) variance from the fact that included study sites are not from a single, homogeneous population, thus there is distribution of true effect sizes. Thus, the random-effects model aims to model the mean of the distribution of true effects.

### Parkinsonism and incident frailty 

FP

```{r, fig.width = 10, fig.height = 6}
mgen = meta::metagen(TE = estimate,                           # make sure log(OR) than OR only
                     seTE = std.error,
                     studlab = study.site,
                     sm = "HR",
                     fixed = TRUE,
                     random = FALSE,
                     method.tau = "DL",                       # DerSimonian-Laird estimator
                     hakn = TRUE,                             # Hartung-Knapp adjustment of SEs
                     prediction = FALSE,                       # the above line and this line allow more uncertainty in the estimation of between-study heterogeneity and appropriate for use in random-effects meta-analysis
                     data = hrs_pnism_fp_adj[-1, ],
                     title = "Association between Parkinsonism and incident frailty (FP)")

meta::forest(mgen, 
             rightlabs = c("HR", "95% CI", "Weight"),
             print.tau2 = FALSE,
             leftcols = c("studlab")
             )

plot_pnism_fp_adj = grid.grab() 
```

MF

```{r, fig.width = 10, fig.height = 6}
mgen = meta::metagen(TE = estimate,                           # make sure log(OR) than OR only
                     seTE = std.error,
                     studlab = study.site,
                     sm = "HR",
                     fixed = TRUE,
                     random = FALSE,
                     method.tau = "DL",                       # DerSimonian-Laird estimator
                     hakn = TRUE,                             # Hartung-Knapp adjustment of SEs
                     prediction = FALSE,                       # the above line and this line allow more uncertainty in the estimation of between-study heterogeneity and appropriate for use in random-effects meta-analysis
                     data = hrs_pnism_mf_adj[-1, ],
                     title = "Association between Parkinsonism and incident frailty (MF)")

meta::forest(mgen, 
             rightlabs = c("HR", "95% CI", "Weight"),
             print.tau2 = FALSE,
             leftcols = c("studlab")
             )

plot_pnism_mf_adj = grid.grab() 
```

FI

```{r, fig.width = 10, fig.height = 6}
mgen = meta::metagen(TE = estimate,                           # make sure log(OR) than OR only
                     seTE = std.error,
                     studlab = study.site,
                     sm = "HR",
                     fixed = TRUE,
                     random = FALSE,
                     method.tau = "DL",                       # DerSimonian-Laird estimator
                     hakn = TRUE,                             # Hartung-Knapp adjustment of SEs
                     prediction = FALSE,                       # the above line and this line allow more uncertainty in the estimation of between-study heterogeneity and appropriate for use in random-effects meta-analysis
                     data = hrs_pnism_fi_adj[-1, ],
                     title = "Association between Parkinsonism and incident frailty (FI)")

meta::forest(mgen, 
             rightlabs = c("HR", "95% CI", "Weight"),
             print.tau2 = FALSE,
             leftcols = c("studlab")
             )

plot_pnism_fi_adj = grid.grab() 
```

### PD and incident frailty 

FP

```{r, fig.width = 10, fig.height = 6}
mgen = meta::metagen(TE = estimate,                           # make sure log(OR) than OR only
                     seTE = std.error,
                     studlab = study.site,
                     sm = "HR",
                     fixed = TRUE,
                     random = FALSE,
                     method.tau = "DL",                       # DerSimonian-Laird estimator
                     hakn = TRUE,                             # Hartung-Knapp adjustment of SEs
                     prediction = FALSE,                       # the above line and this line allow more uncertainty in the estimation of between-study heterogeneity and appropriate for use in random-effects meta-analysis
                     data = hrs_pd_fp_adj[-1, ],
                     title = "Association between PD and incident frailty (FP)")

meta::forest(mgen, 
             rightlabs = c("HR", "95% CI", "Weight"),
             print.tau2 = FALSE,
             leftcols = c("studlab")
             )

plot_pd_fp_adj = grid.grab() 
```

MF

```{r, fig.width = 10, fig.height = 6}
mgen = meta::metagen(TE = estimate,                           # make sure log(OR) than OR only
                     seTE = std.error,
                     studlab = study.site,
                     sm = "HR",
                     fixed = TRUE,
                     random = FALSE,
                     method.tau = "DL",                       # DerSimonian-Laird estimator
                     hakn = TRUE,                             # Hartung-Knapp adjustment of SEs
                     prediction = FALSE,                       # the above line and this line allow more uncertainty in the estimation of between-study heterogeneity and appropriate for use in random-effects meta-analysis
                     data = hrs_pd_mf_adj[-1, ],
                     title = "Association between PD and incident frailty (MF)")

meta::forest(mgen, 
             rightlabs = c("HR", "95% CI", "Weight"),
             print.tau2 = FALSE,
             leftcols = c("studlab")
             )

plot_pd_mf_adj = grid.grab() 
```

FI

```{r, fig.width = 10, fig.height = 6}
mgen = meta::metagen(TE = estimate,                           # make sure log(OR) than OR only
                     seTE = std.error,
                     studlab = study.site,
                     sm = "HR",
                     fixed = TRUE,
                     random = FALSE,
                     method.tau = "DL",                       # DerSimonian-Laird estimator
                     hakn = TRUE,                             # Hartung-Knapp adjustment of SEs
                     prediction = FALSE,                       # the above line and this line allow more uncertainty in the estimation of between-study heterogeneity and appropriate for use in random-effects meta-analysis
                     data = hrs_pd_fi_adj[-1, ],
                     title = "Association between PD and incident frailty (FI)")

meta::forest(mgen, 
             rightlabs = c("HR", "95% CI", "Weight"),
             print.tau2 = FALSE,
             leftcols = c("studlab")
             )

plot_pd_fi_adj = grid.grab() 
```

### Combine and save outputs

```{r}
plot_combined_pnism_adj = cowplot::plot_grid(plot_pnism_fp_adj, plot_pnism_mf_adj, plot_pnism_fi_adj,
                                         align = "hv",
                                         labels = "AUTO", 
                                         scale = 0.5,
                                         ncol = 1)

ggsave(plot = plot_combined_pnism_adj, filename = here::here("Output", "PD and frailty paper", "plots", "hrs_pnism_frailty_adj.png"), width = 18, height = 24, units = "cm")

plot_combined_pd_adj = cowplot::plot_grid(plot_pd_fp_adj, plot_pd_mf_adj, plot_pd_fi_adj,
                                         align = "hv",
                                         labels = "AUTO", 
                                         scale = 0.5,
                                         ncol = 1)

ggsave(plot = plot_combined_pd_adj, filename = here::here("Output", "PD and frailty paper", "plots", "hrs_pd_frailty_adj.png"), width = 18, height = 24, units = "cm")
```