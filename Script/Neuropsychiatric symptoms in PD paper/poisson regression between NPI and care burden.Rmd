---
title: "Analysis 2 Association between total NPI and care burden (zarit score)"
output: html_document
date: "2022-10-26"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
```

### Open libraries

```{r}
library(AER)        # for dispersiontest() to test for overdispersion in data
library(epiR)       # for epi.conf() to calculate CIs for prevalence
library(here)       # for easy file referencing by using the top-level directory of a file project
library(knitr)
library(labelled)   # for var_label() to get variable labels
library(openxlsx)   # for write.xlsx()
library(pscl)       # for zeroinfl() to run zero-inflated Poisson model
library(readxl)     # for read_excel()
library(tableone)
library(tidyverse)
```

What is the top-level of current project?
```{r}
here::here()
```

## Open data

### Open 10/66 baseline dataset

Source codes
```{r}
source(here::here("Script", "Functions", "Data process", "func_open_and_process_data.R"))
source(here::here("Script", "Functions", "Data process", "func_compute_pd_variables.R"))
```

Set path for function input 
```{r}
path = here::here("Data", "raw data", "baseline survey", "prevalence_survey_data_1_3.dta")
```

Open dataset
```{r}
data = open_and_process_data(path, "dta") # this function opens a Stata dataset (dta) and converts Stata's labelled variables into factors
```

### Process dataset

Process Parkinsonism and PD variables
```{r}
data = compute_pd_variables(data)
```

Drop observations from China or India
```{r}
data = data %>% filter(!countryid %in% c("China", "India"))

# drop unused factor levels
data$countryid = droplevels(data$countryid)
```

Subset relevant variables
```{r}
varnames = data %>% 
  select(houseid2, PARTICID, countryid, age, gender, rural, Nassets, anycare, illnocat, PCVA, cdem1066, PEDUC, zbtot, CAREEDUC, CARENEED, dsmdisab, starts_with("NPI"), starts_with("CARER"), starts_with("NEO1"), starts_with("NEO6"), starts_with("NEO4"), starts_with("NOE1"), pnism, JorgePD, combined) %>% 
  names()

data = data %>% select_if(names(.) %in% varnames)
```

Create variable = total number of the NPI symptoms present [0-12]
```{r}
temp = data %>% 
  select(starts_with("NPI"), -ends_with("D"), -ends_with("DIS"), -ends_with("SEV"), -npisev, -npidis, -combined) %>% 
  mutate(across(everything(), ~if_else(.x=="yes", 1, 0))) %>%
  mutate(npi_sum = rowSums(., na.rm = TRUE),
         npi_bin = if_else(npi_sum == 0, "no", "yes"),
         npi_sum_cat = factor(case_when(is.na(npi_sum) ~ NA_character_,
                                        npi_sum == 0 ~ "0",
                                        npi_sum == 1 ~ "1",
                                        npi_sum == 2 ~ "2",
                                        TRUE ~ "3 or more"))) %>%
  select(npi_sum, npi_bin, npi_sum_cat)
  
data = bind_cols(data, temp)
```

## Description of data

Distribution of care burden (zarit score)
```{r}
summary(data$zbtot)
sum(!is.na(data$zbtot))
hist(data$zbtot)
```
Lots of zeros! Also, 9,811 missing zarit score, only 3054 participants will be included in the subsequent regression models.

Overdispersion test
```{r}
summary(pm <- glm(zbtot ~ npi_sum, family="poisson", data=data))
AER::dispersiontest(pm)
```
Residual deviance is 52470 for 3399 degrees of freedom. A rule of thumb is that ratio of deviance to df should be 1. Here it is much greater. A formal test using `dispersontest()` shows substantial dispersion.

Distribution of NPI severity and distress scores
```{r}
hist(data$npisev)
hist(data$npidis)
```

Distribution of the number of NPS
```{r}
hist(data$npi_sum)
```

## Zero-inflated negative binomial Regression

For modelling count variables with excessive zeros and over-dispersed count outcome variables. Model assumes that excess zeros are generated by a separate process from the count values & that the excess zeros can be modeled independently. Assumes there are 2 types of zeros: 'structural' zeros are the people who can only have zeros; 'sampling zeros' are he people who could have experienced non-zero outcomes but by chance experienced zeros.

Zero-inflated models have 2 parts. A logit model to model the processes associated with the zero outcome (i.e. structural zeros); and a count model (e.g. negative binomial model or zero-inflated model) to model the count process.

In our setting, the individuals with zero outcome (zero care burden score) is likely affected by whether their caregiver said 'yes' to having any of the NPI symptoms OR their clinical diagnosis. So, let's try putting `npi_bin` and `combined` in the logit model.

```{r}
m1 = pscl::zeroinfl(as.integer(zbtot) ~ npi_sum | npi_bin, dist = "negbin", data = data)

summary(m1)
```

```{r}
m2 = pscl::zeroinfl(as.integer(zbtot) ~ npi_sum | combined, dist = "negbin", data = data)

summary(m2)
```

```{r}
m3 = pscl::zeroinfl(as.integer(zbtot) ~ npi_sum | npi_bin + combined, dist = "negbin", data = data)

summary(m3)
```

### Association between the number of NPI and care burden

```{r}
m1adj = pscl::zeroinfl(as.integer(zbtot) ~ npi_sum + CARERAGE + CARERSEX + CAREEDUC + illnocat | npi_bin + combined, dist = "negbin", data = data)

summary(m1adj)
```
Run model between the number of NPIs and care burden

```{r}
# Function to run cox models adjusted for age, sex, and region
func_negbin_regression = function(data, outcome, exposure, adjustment){ # input outcome, exposure, and adjustment as characters
  
  # formula
  formula = as.formula(paste(outcome, " ~ ", exposure, adjustment))
  
  # model
  model = pscl::zeroinfl(formula, dist = "negbin", data = data)
  
  # Extract data
  results = summary(model)$coefficients
  
  count = as.data.frame(results[[1]])
  zero = as.data.frame(results[[2]])
  
  count_model = data.frame(
    #exposure = exposure,
    predictor = row.names(count),
    rr = exp(count$Estimate),
    lq = exp(count$Estimate - 1.96*count$`Std. Error`),
    uq = exp(count$Estimate + 1.96*count$`Std. Error`)
    )
  
  count_model = count_model %>% 
    mutate(count_model_rr = paste0(format(round(rr, 2), nsmall=2), " (", format(round(lq, 2), nsmall=2), "-", format(round(uq, 2), nsmall=2), ")")) %>% 
    select(-rr, -lq, -uq)
  
  count_model
  
  zero_model = data.frame(
    #exposure = exposure,
    predictor = row.names(zero),
    or = exp(zero$Estimate),
    lq = exp(zero$Estimate - 1.96*zero$`Std. Error`),
    uq = exp(zero$Estimate + 1.96*zero$`Std. Error`)
    )
  
  zero_model = zero_model %>% 
    mutate(zero_model_or = paste0(format(round(or, 2), nsmall=2), " (", format(round(lq, 2), nsmall=2), "-", format(round(uq, 2), nsmall=2), ")")) %>% 
    select(-or, -lq, -uq)
  
  zero_model
  
  output = list(count_model, zero_model)
                       
  return(output)
}

zeronb_npicount_careburden_crude = func_negbin_regression(data = data, outcome="as.integer(zbtot)", exposure = "npi_sum", adjustment=" | npi_bin + combined")
zeronb_npicount_careburden_adj = func_negbin_regression(data = data, outcome="as.integer(zbtot)", exposure = "npi_sum", adjustment=" + CARERAGE + CARERSEX + CAREEDUC + illnocat | npi_bin + combined")
```

### Association between the total NPI severity score and care burden

```{r}
zeronb_npisev_careburden_crude = func_negbin_regression(data = data, outcome="as.integer(zbtot)", exposure = "npisev", adjustment=" | npi_bin + combined")
zeronb_npisev_careburden_adj = func_negbin_regression(data = data, outcome="as.integer(zbtot)", exposure = "npisev", adjustment=" + CARERAGE + CARERSEX + CAREEDUC + illnocat | npi_bin + combined")
```

### Association between the total NPI distress score and care burden

```{r}
zeronb_npidis_careburden_crude = func_negbin_regression(data = data, outcome="as.integer(zbtot)", exposure = "npidis", adjustment=" | npi_bin + combined")
zeronb_npidis_careburden_adj = func_negbin_regression(data = data, outcome="as.integer(zbtot)", exposure = "npidis", adjustment=" + CARERAGE + CARERSEX + CAREEDUC + illnocat | npi_bin + combined")
```

Save outputs
```{r}
count_model_crude = do.call(rbind, list(zeronb_npicount_careburden_crude[[1]],
                                        zeronb_npisev_careburden_crude[[1]],
                                        zeronb_npidis_careburden_crude[[1]]))

count_model_adj = do.call(rbind, list(zeronb_npicount_careburden_adj[[1]],
                                        zeronb_npisev_careburden_adj[[1]],
                                        zeronb_npidis_careburden_adj[[1]]))

zero_model_crude = do.call(rbind, list(zeronb_npicount_careburden_crude[[2]],
                                        zeronb_npisev_careburden_crude[[2]],
                                        zeronb_npidis_careburden_crude[[2]]))

zero_model_adj = do.call(rbind, list(zeronb_npicount_careburden_adj[[2]],
                                        zeronb_npisev_careburden_adj[[2]],
                                        zeronb_npidis_careburden_adj[[2]]))

write.csv(count_model_crude, file = here::here("Output", "Neuropsychiatric symptoms in PD paper", "Table7 zeronb count model crude.csv"))
write.csv(count_model_adj, file = here::here("Output", "Neuropsychiatric symptoms in PD paper", "Table7 zeronb count model adj.csv"))
write.csv(zero_model_crude, file = here::here("Output", "Neuropsychiatric symptoms in PD paper", "Table7 zeronb zero model crude.csv"))
write.csv(zero_model_adj, file = here::here("Output", "Neuropsychiatric symptoms in PD paper", "Table7 zeronb zero model adj.csv"))
```

### Association of individual NPI And care burden

```{r}
# Function to run cox models adjusted for age, sex, and region
func_negbin_regression1 = function(data, outcome, exposure, adjustment){ # input outcome, exposure, and adjustment as characters
  
  # formula
  formula = as.formula(paste(outcome, " ~ ", exposure, adjustment))
  
  # model
  model = pscl::zeroinfl(formula, dist = "negbin", data = data)
  
  # Extract data
  results = summary(model)$coefficients
  
  count = as.data.frame(results[[1]])
  zero = as.data.frame(results[[2]])
  
  count_model = data.frame(
    #exposure = exposure,
    predictor = row.names(count),
    rr = exp(count$Estimate),
    lq = exp(count$Estimate - 1.96*count$`Std. Error`),
    uq = exp(count$Estimate + 1.96*count$`Std. Error`)
    )
  
  count_model = count_model %>% 
    mutate(count_model_rr = paste0(format(round(rr, 2), nsmall=2), " (", format(round(lq, 2), nsmall=2), "-", format(round(uq, 2), nsmall=2), ")")) %>% 
    select(-rr, -lq, -uq)
  
  count_model
  
  zero_model = data.frame(
    #exposure = exposure,
    predictor = row.names(zero),
    or = exp(zero$Estimate),
    lq = exp(zero$Estimate - 1.96*zero$`Std. Error`),
    uq = exp(zero$Estimate + 1.96*zero$`Std. Error`)
    )
  
  zero_model = zero_model %>% 
    mutate(zero_model_or = paste0(format(round(or, 2), nsmall=2), " (", format(round(lq, 2), nsmall=2), "-", format(round(uq, 2), nsmall=2), ")")) %>% 
    select(-or, -lq, -uq)
  
  zero_model
  
  output = list(count_model, zero_model)
                       
  return(output)
}

npi_ls = c("NPI1", "NPI2", "NPI3", "NPI4", "NPI5", "NPI6",  
           "NPI7", "NPI8", "NPI9", "NPI10", "NPI11", "NPI12")

output_ls1 = map(npi_ls, func_negbin_regression1, data=data, outcome="as.integer(zbtot)", adjustment=" | npi_bin + combined")
output_ls2 = map(npi_ls, func_negbin_regression1, data=data, outcome="as.integer(zbtot)", adjustment=" + CARERAGE + CARERSEX + CAREEDUC + illnocat | npi_bin + combined")
```


Process output data
```{r}
output_data1 = do.call(rbind, output_ls1[[1]]) %>% 
  left_join(npi, by = c("outcome" = "variable")) %>% 
  mutate(ors = paste0(format(round(or,2), nsmall=2), " (", format(round(lci,2), nsmall=2), "-", format(round(uci,2), nsmall=2), ")")) %>% 
  select(description, level, case, noncase, crude_ors = ors)

output_data2 = do.call(rbind, output_ls2) %>% 
  left_join(npi, by = c("outcome" = "variable")) %>% 
  mutate(ors = paste0(format(round(or,2), nsmall=2), " (", format(round(lci,2), nsmall=2), "-", format(round(uci,2), nsmall=2), ")")) %>% 
  select(description, level, adjusted_ors = ors)

output_data = output_data1 %>% 
  left_join(output_data2, by = c("description", "level"))

output_data

write.csv(output_data, file = here::here("Output", "Neuropsychiatric symptoms in PD paper", "Table4 Logistic regression.csv"))
```